<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Destinos - WIT</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="styles.css">
<style>
/* Scroll para tablas largas */
.table-responsive {
    max-height: 400px;
    overflow-y: auto;
}
</style>
</head>
<body class="dashboard-page">
<div class="wrapper">
    <!-- Sidebar -->
    <nav id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h3>WIT</h3>
            <div class="user-info">
                <i class="bi bi-x-circle"></i>
                <div>
                    <div class="user-email" id="userEmail"></div>
                    <div class="user-role" id="userRole"></div>
                </div>
            </div>
        </div>

        <ul class="list-unstyled components">
            <li><a href="dashboard.html"><i class="bi bi-grid"></i> Dashboard</a></li>
            <li><a href="banos.html"><i class="bi bi-droplet"></i> Ba√±os</a></li>
            <li><a href="custodia.html"><i class="bi bi-shield-check"></i> Custodia</a></li>
            <li><a href="parking.html"><i class="bi bi-car-front"></i> Parking</a></li>
            <li><a href="andenes.html"><i class="bi bi-signpost"></i> Andenes</a></li>
            <li><a href="caja.html"><i class="bi bi-cash-coin"></i> Caja</a></li>
            <li><a href="monitoreo.html"><i class="bi bi-display"></i> Monitoreo</a></li>
            <li class="menu-section">CONFIGURACI√ìN</li>
            <li><a href="empresas.html"><i class="bi bi-building"></i> Empresas</a></li>
            <li class="active"><a href="destinos.html"><i class="bi bi-geo-alt"></i> Destinos</a></li>
            <li><a href="usuarios.html"><i class="bi bi-people"></i> Usuarios</a></li>
            <li><a href="listas-blancas.html"><i class="bi bi-list-check"></i> Listas Blancas</a></li>
            <li><a href="pagos-diarios.html"><i class="bi bi-currency-dollar"></i> Pagos Diarios</a></li>
            <li><a href="entradas-salidas.html"><i class="bi bi-arrow-left-right"></i> Entradas y Salidas</a></li>
            <li><a href="#" id="logoutBtn"><i class="bi bi-box-arrow-right"></i> Log Out</a></li>
        </ul>
    </nav>

    <!-- Page Content -->
    <div id="content">
        <div class="top-bar">
            <h4>Sistema de Control de Terminales Terrestres</h4>
        </div>

        <div class="container-fluid">
            <div class="page-header mb-4">
                <h2>Destinos</h2>
                <p class="text-muted">Gesti√≥n de destinos y tarifas</p>
            </div>

            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <label class="me-2">Mostrar</label>
                        <select id="entriesPerPage" class="form-select form-select-sm d-inline-block w-auto">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                        </select>
                        <span class="ms-2">registros</span>
                    </div>
                    <div class="d-flex gap-2">
                        <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="üîç Buscar: Ingresa un t√©rmino">
                        <button class="btn btn-primary btn-sm" onclick="openDestinationModal()">
                            Crear Destino
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Ciudad</th>
                                    <th>Valor</th>
                                    <th>Tipo</th>
                                    <th>Controles</th>
                                </tr>
                            </thead>
                            <tbody id="destinationsTable"></tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div id="tableInfo">Mostrando registros</div>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary">Primero</button>
                            <button class="btn btn-sm btn-outline-secondary">Anterior</button>
                            <span class="mx-2">1</span>
                            <button class="btn btn-sm btn-outline-secondary">Siguiente</button>
                            <button class="btn btn-sm btn-outline-secondary">√öltimo</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Destination Modal -->
<div class="modal fade" id="destinationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="destinationModalTitle">Crear Destino</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="destinationForm">
                    <input type="hidden" id="destinationId">
                    <div class="mb-3">
                        <label for="destinationCity" class="form-label">Ciudad</label>
                        <input type="text" class="form-control" id="destinationCity" required>
                    </div>
                    <div class="mb-3">
                        <label for="destinationValue" class="form-label">Valor</label>
                        <input type="number" class="form-control" id="destinationValue" required>
                    </div>
                    <div class="mb-3">
                        <label for="destinationType" class="form-label">Tipo</label>
                        <select class="form-select" id="destinationType" required>
                            <option value="nacional">Nacional</option>
                            <option value="internacional">Internacional</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveDestination()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
const API_URL = "http://localhost/parkingCalama/php/destinos/api.php";

$(document).ready(function() {
    loadDestinationsTable();

    $('#searchInput').on('keyup', loadDestinationsTable);
});

// --- API Functions ---
async function getDestinations() {
    try { const res = await axios.get(API_URL); return res.data; }
    catch (err) { console.error(err); return []; }
}
async function getDestinationById(id) {
    try { const res = await axios.get(`${API_URL}?id=${id}`); return res.data; }
    catch (err) { console.error(err); return null; }
}
async function addDestination(destination) { try { await axios.post(API_URL, destination); } catch(e){console.error(e); alert('Error al agregar');} }
async function updateDestination(destination) { try { await axios.put(API_URL, destination); } catch(e){console.error(e); alert('Error al actualizar');} }
async function removeDestination(id) { try { await axios.delete(API_URL,{data:{id}}); } catch(e){console.error(e); alert('Error al eliminar');} }

// --- Table Rendering ---
async function loadDestinationsTable(){
    const destinations = await getDestinations();
    const searchTerm = $('#searchInput').val().toLowerCase();
    const tbody = $('#destinationsTable');
    tbody.empty();
    const filtered = destinations.filter(d => d.ciudad.toLowerCase().includes(searchTerm) || d.tipo.toLowerCase().includes(searchTerm));
    filtered.forEach(d => {
        tbody.append(`
            <tr>
                <td>${d.iddest}</td>
                <td>${d.ciudad}</td>
                <td>$${d.valor.toLocaleString()}</td>
                <td>${d.tipo}</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="editDestination(${d.iddest})"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-sm btn-danger" onclick="deleteDestination(${d.iddest})"><i class="bi bi-trash"></i></button>
                </td>
            </tr>
        `);
    });
    $('#tableInfo').text(`Mostrando 1 a ${filtered.length} de ${filtered.length} registros`);
}

// --- Modal Functions ---
async function openDestinationModal(destId=null){
    $('#destinationForm')[0].reset();
    if(destId){
        const dest = await getDestinationById(destId);
        $('#destinationModalTitle').text('Editar Destino');
        $('#destinationId').val(dest.iddest);
        $('#destinationCity').val(dest.ciudad);
        $('#destinationValue').val(dest.valor);
        $('#destinationType').val(dest.tipo);
    } else { $('#destinationModalTitle').text('Crear Destino'); $('#destinationId').val(''); }
    new bootstrap.Modal(document.getElementById('destinationModal')).show();
}

// --- CRUD Actions ---
async function saveDestination(){
    const id = $('#destinationId').val();
    const ciudad = $('#destinationCity').val();
    const valor = parseInt($('#destinationValue').val());
    const tipo = $('#destinationType').val();
    const dest = { ciudad, valor, tipo };
    if(id){ dest.id = parseInt(id); await updateDestination(dest); alert('Destino actualizado'); }
    else { await addDestination(dest); alert('Destino creado'); }

    // Cerrar modal
    const modalEl = document.getElementById('destinationModal');
    const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
    modal.hide();
    $('.modal-backdrop').remove();
    $('body').removeClass('modal-open').css('padding-right','');

    loadDestinationsTable();
}

async function editDestination(id){ await openDestinationModal(id); }
async function deleteDestination(id){ if(confirm('¬øEliminar destino?')){ await removeDestination(id); alert('Destino eliminado'); loadDestinationsTable(); } }
</script>
</body>
</html>
