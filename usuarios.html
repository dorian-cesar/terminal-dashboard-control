<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Usuarios - WIT</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="dashboard.css">
<style>
.table-responsive {
    max-height: 400px;
    overflow-y: auto;
}
</style>
</head>
<body class="dashboard-page">
<div class="wrapper">
    <!-- Sidebar -->
    <nav id="sidebar" class="sidebar">
        <div class="sidebar-header">
            <h3>WIT</h3>
            <div class="user-info">
                <i class="bi bi-x-circle"></i>
                <div>
                    <div class="user-email" id="userEmail"></div>
                    <div class="user-role" id="userRole"></div>
                </div>
            </div>
        </div>

        <ul class="list-unstyled components">
            <li><a href="dashboard.html"><i class="bi bi-grid"></i> Dashboard</a></li>
            <li><a href="banos.html"><i class="bi bi-droplet"></i> Baños</a></li>
            <li><a href="custodia.html"><i class="bi bi-shield-check"></i> Custodia</a></li>
            <li><a href="parking.html"><i class="bi bi-car-front"></i> Parking</a></li>
            <li><a href="andenes.html"><i class="bi bi-signpost"></i> Andenes</a></li>
            <li><a href="caja.html"><i class="bi bi-cash-coin"></i> Caja</a></li>
            <li><a href="monitoreo.html"><i class="bi bi-display"></i> Monitoreo</a></li>
            <li class="menu-section">CONFIGURACIÓN</li>
            <li><a href="empresas.html"><i class="bi bi-building"></i> Empresas</a></li>
            <li><a href="destinos.html"><i class="bi bi-geo-alt"></i> Destinos</a></li>
            <li class="active"><a href="usuarios.html"><i class="bi bi-people"></i> Usuarios</a></li>
            <li><a href="listas-blancas.html"><i class="bi bi-list-check"></i> Listas Blancas</a></li>
            <li><a href="pagos-diarios.html"><i class="bi bi-currency-dollar"></i> Pagos Diarios</a></li>
            <li><a href="entradas-salidas.html"><i class="bi bi-arrow-left-right"></i> Entradas y Salidas</a></li>
            <li><a href="#" id="logoutBtn"><i class="bi bi-box-arrow-right"></i> Log Out</a></li>
        </ul>
    </nav>

    <!-- Page Content -->
    <div id="content">
        <div class="top-bar">
            <h4>Sistema de Control de Terminales Terrestres</h4>
        </div>

        <div class="container-fluid">
            <div class="page-header mb-4">
                <h2>Usuarios</h2>
                <p class="text-muted">Gestión de usuarios</p>
            </div>

            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <label class="me-2">Mostrar</label>
                        <select id="entriesPerPage" class="form-select form-select-sm d-inline-block w-auto">
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                        </select>
                        <span class="ms-2">registros</span>
                    </div>
                    <div class="d-flex gap-2">
                        <input type="text" id="searchInput" class="form-control form-control-sm" placeholder="🔍 Buscar: correo o sección">
                        <button class="btn btn-primary btn-sm" onclick="openUserModal()">
                            Crear Usuario
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Correo</th>
                                    <th>Nivel</th>
                                    <th>Sección</th>
                                    <th>Controles</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable"></tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div id="tableInfo">Mostrando registros</div>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary">Primero</button>
                            <button class="btn btn-sm btn-outline-secondary">Anterior</button>
                            <span class="mx-2">1</span>
                            <button class="btn btn-sm btn-outline-secondary">Siguiente</button>
                            <button class="btn btn-sm btn-outline-secondary">Último</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Modal -->
<div class="modal fade" id="userModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalTitle">Crear Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="mb-3">
                        <label for="userEmailInput" class="form-label">Correo</label>
                        <input type="email" class="form-control" id="userEmailInput" required>
                    </div>
                    <div class="mb-3">
                        <label for="userPassInput" class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="userPassInput" placeholder="Dejar vacío para no cambiar">
                    </div>
                    <div class="mb-3">
                        <label for="userLevelInput" class="form-label">Nivel</label>
                        <select class="form-select" id="userLevelInput" required>
                            <option value="1">Usuario 1</option>
                            <option value="2">Usuario 2</option>
                            <option value="3">Admin</option>
                            <option value="4">SuperUser</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="userSectionInput" class="form-label">Sección</label>
                        <input type="text" class="form-control" id="userSectionInput" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveUser()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
const API_URL = "http://localhost/parkingCalama/php/users/api.php";

// --- Cargar tabla ---
async function getUsers() {
    try { const res = await axios.get(API_URL); return res.data; }
    catch (err) { console.error(err); return []; }
}

async function getUserById(id) {
    try { const res = await axios.get(`${API_URL}?id=${id}`); return res.data; }
    catch (err) { console.error(err); return null; }
}

async function addUser(user) { try { await axios.post(API_URL,user); } catch(e){console.error(e); alert('Error al agregar usuario');} }
async function updateUser(user) { try { await axios.put(API_URL,user); } catch(e){console.error(e); alert('Error al actualizar usuario');} }
async function removeUser(id) { try { await axios.delete(API_URL,{data:{id}}); } catch(e){console.error(e); alert('Error al eliminar usuario');} }

async function loadUsersTable(){
    const users = await getUsers();
    const searchTerm = $('#searchInput').val().toLowerCase();
    const tbody = $('#usersTable');
    tbody.empty();
    const filtered = users.filter(u => u.mail.toLowerCase().includes(searchTerm) || u.seccion.toLowerCase().includes(searchTerm));
    filtered.forEach(u=>{
        tbody.append(`
            <tr>
                <td>${u.iduser}</td>
                <td>${u.mail}</td>
                <td>${u.descriptor}</td>
                <td>${u.seccion}</td>
                <td>
                    <button class="btn btn-sm btn-warning" onclick="editUser(${u.iduser})"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.iduser})"><i class="bi bi-trash"></i></button>
                </td>
            </tr>
        `);
    });
    $('#tableInfo').text(`Mostrando 1 a ${filtered.length} de ${filtered.length} registros`);
}

// --- Modal ---
async function openUserModal(userId=null){
    $('#userForm')[0].reset();
    if(userId){
        const user = await getUserById(userId);
        $('#userModalTitle').text('Editar Usuario');
        $('#userId').val(user.iduser);
        $('#userEmailInput').val(user.mail);
        $('#userPassInput').val('');
        $('#userLevelInput').val(user.nivel);
        $('#userSectionInput').val(user.seccion);
    } else { $('#userModalTitle').text('Crear Usuario'); $('#userId').val(''); }
    new bootstrap.Modal(document.getElementById('userModal')).show();
}

// --- CRUD ---
async function saveUser(){
    const id = $('#userId').val();
    const mail = $('#userEmailInput').val();
    const pass = $('#userPassInput').val();
    const lvl = parseInt($('#userLevelInput').val());
    const seccion = $('#userSectionInput').val();
    const user = { mail, lvl, seccion };
    if(pass) user.pass = pass;
    if(id){ user.id = parseInt(id); await updateUser(user); alert('Usuario actualizado'); }
    else { await addUser(user); alert('Usuario creado'); }

    const modalEl = document.getElementById('userModal');
    const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
    modal.hide();
    $('.modal-backdrop').remove();
    $('body').removeClass('modal-open').css('padding-right','');

    loadUsersTable();
}

async function editUser(id){ await openUserModal(id); }
async function deleteUser(id){ if(confirm('¿Eliminar usuario?')){ await removeUser(id); alert('Usuario eliminado'); loadUsersTable(); } }

$(document).ready(function(){
    loadUsersTable();
    $('#searchInput').on('keyup', loadUsersTable);
});
</script>
</body>
</html>
